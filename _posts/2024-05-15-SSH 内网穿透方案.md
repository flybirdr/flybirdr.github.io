# SSH 内网穿透方案



# 背景

日常上班家里一台机器，公司一台机器。有的时候需要连接家里的机器做些事情（摸鱼）。但是家里的机器是在内网的，应该是内网的内网，毕竟运营商网络也算是个内网，公司的机器也算是内网的内网。这时候就需要家里里的机器穿透内网，使公司的机器可以连到家里的机器。要实现两端的内网穿透必定需要一个处在公网的机器作为桥梁将两端连接起来。

其实网上的方案很多，也有很多傻瓜式的软件可以实现内网穿透，但今天我们使用免费开源的SSH实现内网穿透。但是需要一台处在公网的机器，我使用的是华为云的云服务器，一年只要几十块。可以满足我们内网穿透的需求。



# 架构

实现原理是利用SSH的远程端口转发功能。家里的机器作为目标机器，公司的机器作为本地机器，而云服务器作为远程的端口转发机器。

```
```

# 实现

### 家里的机器

```shell
ssh -NTf -R [REMOTE_IP:]REMOTE_PORT:DST_IP:DST_PORT REMOTE_USER@REMOTE_IP [-p REMOTE_SSH_PORT]

-N：表示只连接远程主机，不打开远程shell
-T：表示不为这个连接分配TTY
-f：表示连接成功后，转入后台运行
-R：表示将端口绑定到远程服务器，反向代理
-p：默认为22端口，当远程服务器ssh端口非22端口时，需要单独指定

我这里执行的是：
ssh -NTf -R 223:192.168.0.7:2222 root@x.x.x.x -p 334

```

这里有几点需要注意

* `REMOTE_IP`可以不指定，但`REMOTE_PORT`必须指定，这个端口是客户端连接远端的端口，也就是公司的机器要连接云服务器的端口

* `DST_IP:DST_PORT`是家里的机器的IP和端口，可以是本机，也可以是内网的任意一台机器，如果是要转发SSH这里就填22（也可以配置其他端口，下面说）

* `REMOTE_USER`是云服务器的用户

* 如果家里的机器需要对外暴露ssh服务那么`DST_PORT`是需要填写的是`sshd`的监听端口

通常来说`ssh`服务的默认端口是`22`，如果要监听多个端口可以编辑`/etc/ssh/sshd_config`，增加如下配置
```txt
	Port 22
	Port 2222
	Port 3333
```
然后执行
```shell
#重启ssh服务
systemctl restart sshd
#查看端口
lsof -i 或者 netstat -tlnp
```
这样就完成了目标机器的配置

### 云服务器配置

通常云服务器只开放少数几个端口比如`80`，`443`。如果我们需要新增一个数据转发端口通常需要到控制台去调整安全策略，开放相应的端口，不同的云服务商做法大同小异。

我家里的机器执行的命令是：
```shell
ssh -NTf -R 223:192.168.0.7:2222 root@x.x.x.x -p 334
```
那么对应的我需要在控制台放行223和334端口，其中223用来接受公司机器的接入，334用来接受家里机器的建联。

我需要在`/etc/ssh/sshd_config`中加入：
```txt
Port 22
Port 334
```
并使用命令：
```shell
#重启ssh服务
service sshd restart
#查看端口
lsof -i 或者 netstat -tlnp
```
重启ssh服务，这样就完成了云服务器的配置。

### 公司的机器连入家里的机器

我们前面在家里的机器和公司的机器分别使用ssh连入云服务器和开启监听，在这里我们需要使用ssh来通过云服务器来连接到家里的机器。

```shell
#注意这里的用户
ssh maclinux@x.x.x.x -p 223
```
值得注意的是ssh命令中指定的用户并不是云服务器的用户，而是家里的机器的用户；端口则是家里机器设置的远程端口。
至此，我们就通过云服务器实现了简单的内网穿透。