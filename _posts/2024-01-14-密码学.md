
记录下学习密码学相关的知识点。

原始文章 https://thiscute.world/posts/practical-cryptography-basics-1/

# 概述
密码学是提供是提供信息安全和保护的科学。
密码学应用场景有：加密与解密、数字签名和消息认证、安全随机数、密钥交换、加密哈希与password哈希

密码学香农提出的混淆（confusion）与扩散（diffusion）是设计安全密码算法的两个原则。

混淆使密文和对称加密中的密钥的映射关系变得尽可能复杂，使之难以分析。如果使用了混淆，那么输出密文中的每个比特位都应该依赖于密钥和输入数据的多个部分，确保两者无法建立直接映射。混淆常用的方法是替换和排列。

扩散将明文的统计结构扩散到大量密文中，隐藏明文与密文间的统计学关系。使单个明文或密钥的影响尽可能扩大到更多明文中去，确保改变输入中任一位都应该导致输出中大约一半位发生变化，反过来改变输出密文中的任一位，明文中大约一半的位也必须发生变化。扩散常用的方法是置换。

## 哈希函数
哈希函数又叫散列函数，是一种从任何数据中创建一个数字指纹（数据摘要）的函数，哈希函数把数据压缩或者放大成一个固定长度的字符串。

有概率发生碰撞。

## 加密哈希函数

一个好的加密哈希函数应该是抗碰撞（collision-resistant）和不可逆（irreversible）的。抗碰撞是指很难通过统计学方法（彩虹表）猜出原始的数据。而不可逆指的是攻击者很难或不可能从算法层面通过哈希值演算出原始数据。

一个理想的哈希函数应当具有以下属性：快速、确定性、难以分析、不可逆、无碰撞。

## 量子安全
现代密码学哈希函数（如SHA2和SHA3）都被认为是量子安全的。

## 哈希函数应用场景

1、数据完整性校验
2、保存密码
3、生成唯一ID
4、伪随机数生成

## 非密码学哈希函数
1、map里面哈希函数计算是将对象各个属性*31然后相加，计算迅速，分布均匀。
2、

## MAC消息认证码

MAC即Message Authentication Code是用于验证消息的一小段信息。能用它确认消息的真是性，完整性。

## MAC的应用场景
1、验证消息的完整性
2、AE（Authenticated Encryption）认证加密，AEAD（Authenticated Encryption with associated data）带有关联数据的认证加密

## KDF密钥派生函数

KDF从以下三个方面提升hash碰撞难度：
1、时间复杂度：对应CPU/GPU计算资源
2、空间复杂度：对应Memory内存资源
3、并行维度：使用无法分解的算法，只允许单线程计算

设计方法是“密钥拉伸Key Stretching”，主要手段是加盐，以及多次迭代。

KDF相比其他哈希函数，计算很慢。也被称为慢哈希算法。

常用的KDF算法有：
1、PBKDF2，不推荐使用
2、Bcrypt：安全性下降
3、Scrypt：可以灵活设置内存大小
4、Argon2：目前最强的密码哈希算法

## 伪随机数生成器 PRNG

在密码学中，熵扮演了非常重要的角色，许多密码学算法实现依赖一个不可预测的随机数来保证其安全性。

另外许多高性能的算法如快速排序、布隆过滤器、蒙特卡洛方法等，都依赖于随机性，如果随机性可以被预测或者能找到特定的输入值使这些算法变得很慢，那黑客就能借此对服务器发动DDos攻击，以很小的成本达到服务不可用的目的。

## CSPRNG 密码学安全随机数生成器

一个PRNG如果具备以下2个条件，它就是一个CSPRNG：
1、能通过“下一个比特测试”：即使有人获知了该PRNG的k位，他也无法使用合理的资源预测第k+i位 
2、如果攻击者才出了PRNG的内部状态或者该状态因某种原因而泄露，攻击者也无法重建出内部状态泄露之前生成的所有随机数

## 密钥交换

在密码学中，密钥交换是一种协议，功能是在两方之间安全地交换加密密钥，其他任何人都无法获得该密钥的副本。密钥交换有两种方案：
1、密钥协商：协议中的双方都参与了共享密钥的生成，两个代表算法是Diffie-Hellman(DHKE)和Elliptic-Curve Diffie-Hellman(ECDH)
2、密钥传输：双方一方生成共享密钥，并通过此方案将共享密钥传输给另一方。密钥传输方案通常都通过公钥密码系统实现。比如在RSA密钥交换中，客户端使用它的公钥加密一个随机生成的会话密钥，然后将密文发送给服务端，服务端再用私钥解密出会话密钥。

一些比较知名的密钥交换协议：
Diffie-Hellman Key Exchange (DHКЕ)：传统的、应用最为广泛的密钥交换协议
Elliptic-curve Diffie–Hellman (ECDH)：基于椭圆曲线密码学的密钥交换算法，DHKE 的继任者
RSA-OAEP 和 RSA-KEM（RSA 密钥传输）
PSK（预共享密钥）
SRP（安全远程密码协议）
FHMQV（Fully Hashed Menezes-Qu-Vanstone）
ECMQV（Ellictic-Curve Menezes-Qu-Vanstone）
CECPQ1（量子安全密钥协议）

## 对称加密
对称加密是指，使用相同的密钥进行消息的加密与解密。因为这个特性，我们也称这个密钥为共享密钥。
现代密码学中广泛使用的对称加密算法有：AES（AES-128，AES-192，AES-256），Chaccha20、Twofish，IDEA，Serpent，RC6、Camelia、CAST等。其中大多数都是块密码算法（Block Cipher）或者叫分组密码算法，这种算法一次只能加密固定大小的块例如128；少部分是流密码算法（Stream Cipher），流密码算法将数据逐字节加密为密文流。

通过使用分组密码工作模式，可以将分组密码算法转换为流密码算法。

## 量子安全性
大多数对称密钥算法都是抗量子的，这意味着使用足够长的密钥时，强大的量子计算机也无法破坏其安全性。

## 对称加密方案结构

单纯使用加密算法只能保证数据的安全性，并不能保证数据的真实性、完整性和不可否认性。因此通常我们将对称加密算法和其他算法组合成一个对称加密方案来使用，这个多个密码学算法组成的加密方案能同时保证数据的安全性、真实性、完整性与不可否认性。
一个对称加密方案通常会包含如下几种算法：
* 将密码转换为密钥的密钥派生算法KDF（如Scrypto，Argon2）：通过使用KDF，加密方案允许用户使用字符密码作为[shared secret key],并使密码的破解变得困难和缓慢。
* 分组密码工作模式（如CBC，CTR，GCM）+消息填充算法（如PKCS7）：借助这两种算法分组密码算法可以加密任意大小的数据。
* 消息认证算法（如HMAC）：用于验证消息的真实性，完整性，不可否认性。

流密码本身就能加密任意长度的数据，因此不需要分组密码模式与消息填充算法。

## 分组密码工作模式

分组密码工作模式可以将分组密码算法转换为流密码算法，从而实现加密任意长度的数据。

* AES-128-CTR：具有128位加密密钥和CTR分组模式的AES密码
* AES-256-GCM：具有256位加密密钥和GCM分组模式的AES密码
* Serpent-128-CBC：具有128位加密密钥和CBC分组模式的Serpent密码

分组密码工作模式的主要思想是将明文分成多个长度固定的组，再把这些分组上重复应用分组密码算法进行加密/解密，以实现安全地加密/解密任意长度的数据。

有些分组模式（如CBC）要求将输入拆分为组，并使用填充算法将最末尾的分组填充到块大小。也有些分组（如CTR、CFB、OFB、CCM、EAX和GCM）不需要填充，因为它们在每个步骤中，都直接在明文部分和内部密码状态之间执行异或运算。

## 初始向量IV

有时也被称作Salt或Nonce。初始向量通常是一个随机数，主要作用是往密文中添加随机性，使同样的明文被多次加密也会产生不同的密文，从而确保密文的不可预测性。

IV的大小应与密码块大小相同。

IV通常无需保密，但应足够随机，而且不允许重用，应对每条加密消息使用随机且不可预测的IV。
## CTR（Counter）分组模式
将明文/密文拆分成一个个长度固定的分组，然后使用一定的算法进行加密与解密。
## GCM（Galois/Counter）分组模式

在CTR的基础上添加了消息认证的功能。

## 选用分组模式
* 常用的安全块模式是 CBC（密码块链接）、CTR（计数器）和 GCM（伽罗瓦/计数器模式），它们需要一个随机（不可预测的）初始化向量 (IV)，也称为 nonce 或 salt
* 「CTR（Counter）」块模式在大多数情况下是一个不错的选择，因为它具有很强的安全性和并行处理能力，允许任意输入数据长度（无填充）。但它不提供身份验证和完整性，只提供加密
* GCM（Galois/Counter Mode）块模式继承了 CTR 模式的所有优点，并增加了加密消息认证能力。GCM 是在对称密码中实现认证加密的快速有效的方法，强烈推荐
* CBC 模式在固定大小的分组上工作。因此，在将输入数据拆分为分组后，应使用填充算法使最后一个分组的长度一致。大多数应用程序使用 PKCS7 填充方案或 ANSI X.923. 在某些情况下，CBC 阻塞模式可能容易受到「padding oracle」攻击，因此最好避免使用 CBC 模式
* 众所周知的不安全块模式是 ECB（电子密码本），它将相等的输入块加密为相等的输出块（无加密扩散能力）。不要使用 ECB 块模式！它可能会危及整个加密方案。
* CBC、CTR 和 GCM 模式等大多数块都支持「随机访问」解密。比如在视频播放器中的任意时间偏移处寻找，播放加密的视频流

总之建议选用CTR或者GCM分组模式。它们是安全的，可以加密任意长度的数据，无需填充，可以并行加密/解密分组，GCM还提供了消息认证功能，是一般密码块模式的推荐选择。


## 安全的对称加密算法

* AES
* Salsa20，Chacha20

AES(高级加密标准)，是使用最广泛的对称加密算法。到目前为止被认为是安全的，没有任何明显的弱点和攻击手段。AES是128位分组密码，使用128、192、256位密钥。AES作为TLS协议的一部分，并且在现代CPU上都有指令加速支持。

Salsa20及其改进的变体Chacha和XSalsa20是由密码学家Daniel Bernstein设计的。

Salsa20密码将128位或256位对称密钥+随机生成的64位随机数（初始向量）和无限长的数据流作为输入，并生成长度相同的额加密数据流作为输入流。

## Chacha20-Poly1305
Salsa20 应用最为广泛的是认证加密方案：ChaCha20-Poly1305，即组合使用 ChaCha20 与消息认证算法 Poly1305，它们都由密码学家 Bernstein 设计。

ChaCha20-Poly1305 已被证明足够安全，不过跟 GCM 一样它的安全性也依赖于足够随机的初始向量 IV，另外 ChaCha20-Poly1305 也不容易遭受计时攻击。

在没有硬件加速的情况下，ChaCha20 通常比 AES 要快得多（比如在旧的没有硬件加速的移动设备上），这是它最大的优势。

## 其他流行的对称加密算法

* Serpent - 安全对称密钥分组密码（密钥大小：128、192 或 256 位），公众所有（Public Domain），完全免费
* Twofish - 安全对称密钥分组密码（密钥大小：128、192 或 256 位），公众所有（Public Domain），完全免费
* Camellia - 安全对称密钥分组密码（分组大小：128 位；密钥大小：128、192 和 256 位），专利算法，但完全免费，该算法由三菱和日本电信电话（NTT）在 2000 年共同发明
* RC5 - 安全对称密钥分组密码（密钥大小：128 到 2040 位；分组大小：32、64 或 128 位；轮数：1 … 255），短密钥不安全（56 位密钥已被暴力破解） , 专利在 2015 年到期，现在完全免费
* RC6 - 安全对称密钥分组密码，类似于 RC5，但更复杂（密钥大小：128 到 2040 位；分组大小：32、64 或 128 位；轮数：1 … 255），专利在 2017 年到期，现在完全免费
* IDEA - 安全对称密钥分组密码（密钥大小：128 位），所有专利在均 2012 年前过期，完全免费
* CAST (CAST-128 / CAST5, CAST-256 / CAST6) - 安全对称密钥分组密码系列（密钥大小：40 … 256 位），免版税
* ARIA - 安全对称密钥分组密码，类似于 AES（密钥大小：128、192 或 256 位），韩国官方标准，免费供公众使用
* SM4 - 安全对称密钥分组密码，类似于 AES（密钥大小：128 位），中国官方标准，免费供公众使用，由中国国家密码管理局于 2012 年 3 月 21 日发布

## 不安全的对称加密算法
* DES - 56 位密钥大小，可以被暴力破解
* 3DES（三重 DES, TDES）- 64 位密码，被认为不安全，已在 2017 年被 NIST 弃用.
* RC2 - 64 位密码，被认为不安全
* RC4 - 流密码，已被破解，网上存在大量它的破解资料
* Blowfish - 旧的 64 位密码，已被破坏
* Sweet32: Birthday attacks on 64-bit block ciphers in TLS and OpenVPN
* GOST - 俄罗斯 64 位分组密码，有争议的安全性，被认为有风险

## AEAD

* ChaCha20-Poly1305
  * 具有集成 Poly1305 身份验证器的 ChaCha20 流密码（集成身份验证 AEAD 加密）
  * 使用 256 位密钥和 96 位随机数（初始向量）
  * 极高的性能
  * 在硬件不支持 AES 加速指令时（如路由器、旧手机等硬件上），推荐使用此算法
* AES-256-GCM
  * 我们在前面的 GCM 模式一节，使用 Python 实现并验证了这个 AES-256-GCM 加密方案
  * 使用 256 位密钥和 128 位随机数（初始向量）
  * 较高的性能
  * 在硬件支持 AES 加速时（如桌面、服务器等场景），更推荐使用此算法
* AES-128-GCM
  * 跟 AES-256-GCM 一样，区别在于它使用 128 位密钥，安全性弱于 ChaCha20-Poly1305 与 AES-256-GCM.
  * 目前被广泛应用在 HTTPS 等多种加密场景下，但是正在慢慢被前面两种方案取代
  
## 公钥密码学/非对称加密

对称加密算法问题有两点：

1、需要安全的通道交换密钥
2、每个点对点通信都需要使用不同的密钥，密钥管理会变得困难

非对称加密解决了这两个问题：
1、非对称加密可以在不安全的信道上安全地进行密钥交换
2、只需要公开自己的公钥就可以和其他人安全地进行通信

公钥密码系统主要有三大用途：加密与解密、签名与验证、密钥交换。

公钥加密的数据只能由私钥解密。

比较著名的非对称加密系统有：RSA、ECC（椭圆曲线）、ElGamal、Diffie-Hellman、ECDH、ECDSA和EdDSA。